---
title: 'CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»§a CephFS'
description: 'Giá»›i thiá»‡u vá» CephFS - há»‡ thá»‘ng tá»‡p phÃ¢n tÃ¡n máº¡nh máº½ vÃ  linh hoáº¡t'
date: '2024-03-18'
tags: ['Cloudnative', 'Storage', 'Ceph']
authors: ['bachdangtuan']
---

# CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»§a CephFS

## CephFS lÃ  gÃ¬?

**CephFS (Ceph File System)** lÃ  má»™t há»‡ thá»‘ng **lÆ°u trá»¯ file phÃ¢n tÃ¡n** hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ°:

- Má»™t **á»• Ä‘Ä©a máº¡ng (shared drive)**, nÆ¡i nhiá»u mÃ¡y tÃ­nh hoáº·c á»©ng dá»¥ng cÃ³ thá»ƒ truy cáº­p cÃ¹ng lÃºc.
- NhÆ°ng khÃ¡c á»Ÿ chá»—: dá»¯ liá»‡u Ä‘Æ°á»£c **lÆ°u trÃªn nhiá»u á»• Ä‘Ä©a, nhiá»u mÃ¡y chá»§**, cÃ³ kháº£ nÄƒng **phÃ¢n tÃ¡n, sao lÆ°u vÃ  tá»± phá»¥c há»“i**.

---

## CÃ¡ch thá»©c hoáº¡t Ä‘á»™ng CephFS
NgÆ°á»i dÃ¹ng (Client A) lÆ°u file /docs/report.pdf vÃ o trong CephFS.
#### ğŸ“¥ CÃ¡c bÆ°á»›c ngÆ°á»i upload vÃ  lÆ°u dá»¯ liá»‡u:

1. Client mount CephFS â†’ liÃªn há»‡ MON Ä‘á»ƒ biáº¿t thÃ´ng tin cluster.
2. MON tráº£ vá» danh sÃ¡ch cÃ¡c thÃ nh pháº§n Ä‘ang active, bao gá»“m MDS.
3. Client gá»­i yÃªu cáº§u táº¡o file má»›i tá»›i MDS.
4. MDS táº¡o entry metadata cho file má»›i, gÃ¡n inode, quyá»n truy cáº­p, Ä‘Æ°á»ng dáº«n.
5. File Ä‘Æ°á»£c chia thÃ nh cÃ¡c block nhá» (thÆ°á»ng 4MB má»—i block).
6. Má»—i block Ä‘Æ°á»£c gÃ¡n Object ID vÃ  lÆ°u trá»¯ phÃ¢n tÃ¡n lÃªn cÃ¡c OSD khÃ¡c nhau.
7. Má»—i block Ä‘Æ°á»£c replica (máº·c Ä‘á»‹nh 3 báº£n) Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n dá»¯ liá»‡u.
8. MDS cáº­p nháº­t metadata, lÆ°u thÃ´ng tin vá» cÃ¡c block vÃ  vá»‹ trÃ­ cá»§a chÃºng.
9. Sau khi dá»¯ liá»‡u vÃ  metadata Ä‘á»u Ä‘Æ°á»£c commit thÃ nh cÃ´ng, client nháº­n pháº£n há»“i â€œghi thÃ nh cÃ´ngâ€.


{/* - Gá»­i request ghi /docs/report.pdf tá»›i CephFS mountpoint.
- Giao tiáº¿p vá»›i MDS (Metadata Server) Ä‘á»ƒ:
- Táº¡o entry metadata cho file má»›i.
- GÃ¡n inode, quyá»n truy cáº­p, Ä‘Æ°á»ng dáº«n.

2. File Ä‘Æ°á»£c chia nhá» thÃ nh cÃ¡c block

- CephFS sá»­ dá»¥ng cÆ¡ cháº¿ lÆ°u dá»¯ liá»‡u cá»§a RADOS, nÃªn file sáº½ Ä‘Æ°á»£c:
- Chia thÃ nh cÃ¡c chunk nhá» (thÆ°á»ng 4MB má»—i block â€“ configurable)
- GÃ¡n Object ID cho tá»«ng block.
- LÆ°u trá»¯ phÃ¢n tÃ¡n lÃªn cÃ¡c OSD khÃ¡c nhau.

- VÃ­ dá»¥: report.pdf (100 MB) â†’ chia thÃ nh 25 block â†’ má»—i block lÆ°u trÃªn 1 OSD, hoáº·c nhiá»u báº£n sao.

3. Replication (tá»± sao lÆ°u)

- Má»—i block Ä‘Æ°á»£c replica (máº·c Ä‘á»‹nh 3 báº£n) Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n dá»¯ liá»‡u.
- VÃ­ dá»¥:

Block 1 â†’ OSD1, OSD3, OSD5

Block 2 â†’ OSD2, OSD4, OSD6

4. MDS cáº­p nháº­t metadata
   LÆ°u thÃ´ng tin:
   report.pdf gá»“m 25 block, cÃ¡c block náº±m á»Ÿ Ä‘Ã¢u, block nÃ o thuá»™c OSD nÃ o.

5. Ghi hoÃ n táº¥t
   Sau khi dá»¯ liá»‡u vÃ  metadata Ä‘á»u Ä‘Æ°á»£c commit thÃ nh cÃ´ng â†’ client nháº­n pháº£n há»“i â€œghi thÃ nh cÃ´ngâ€. */}

```
                     [1] Client A mount CephFS â†’ há»i MON
                                 |
                                 v
                            +--------+
                            |  MON   |  â† Monitor: Quáº£n lÃ½ cluster map, quorum
                            +--------+
                                 |
                     [2] Tráº£ vá» MDS Ä‘ang active
                                 |
                                 v
                            +--------+
                            |  MDS   |  â† Metadata Server: Quáº£n lÃ½ inode, quyá»n, Ä‘Æ°á»ng dáº«n
                            +--------+
                                 |
         [3] Gá»­i yÃªu cáº§u táº¡o file /docs/report.pdf (metadata)
                                 |
         [4] Chia nhá» file thÃ nh cÃ¡c block (VD: 4MB má»—i block)
                                 |
                                 v
      +-----------+    +-----------+    +-----------+
      |   OSD 1   |    |   OSD 2   |    |   OSD 3   |   â† LÆ°u block dá»¯ liá»‡u thá»±c táº¿
      +-----------+    +-----------+    +-----------+
           |                |                |
           |<---- Replication copies ------->|  â† Tá»± Ä‘á»™ng sao lÆ°u block (replica)

                              â†‘
                              |
                       +-------------+
                       |     MGR     |  â† Manager: Theo dÃµi MON, MDS, OSD, plugin, alerts
                       +-------------+
```
NgÆ°á»i dÃ¹ng (Client A) má»Ÿ file `/docs/report.pdf` Ä‘Æ°á»£c lÆ°u trá»¯ trong CephFS.
#### ğŸ“¥ CÃ¡c bÆ°á»›c ngÆ°á»i dÃ¹ng láº¥y dá»¯ liá»‡u:

            1. **Client A** yÃªu cáº§u má»Ÿ file `report.pdf`.
            2. Client liÃªn há»‡ MON Ä‘á»ƒ láº¥y thÃ´ng tin vá» cluster + MDS hiá»‡n táº¡i.
            3. MON tráº£ vá» danh sÃ¡ch MDS (Ä‘áº·c biá»‡t lÃ  MDS Ä‘ang active).
            4. Client gá»­i yÃªu cáº§u tá»›i MDS Ä‘á»ƒ láº¥y thÃ´ng tin vá» file.
            5. MDS tráº£ vá» thÃ´ng tin vá» file: `report.pdf` náº±m á»Ÿ Ä‘Ã¢u, trÃªn OSD nÃ o.
            6. Client nháº­n thÃ´ng tin â†’ káº¿t ná»‘i trá»±c tiáº¿p tá»›i cÃ¡c OSD chá»©a dá»¯ liá»‡u tháº­t.
            7. Client gá»­i yÃªu cáº§u tá»›i OSD Ä‘á»ƒ láº¥y dá»¯ liá»‡u.
            8. OSD tráº£ vá» dá»¯ liá»‡u cho Client.
            9. Náº¿u 1 OSD bá»‹ lá»—i, Ceph tá»± dÃ¹ng báº£n sao tá»« OSD khÃ¡c (replica).
            10.Náº¿u cÃ³ nhiá»u client, MDS + MON phÃ¢n phá»‘i táº£i há»£p lÃ½.


```
          +------------+
          |  Client A  |
          +------------+
               |
               | 1. Gá»­i yÃªu cáº§u mount CephFS
               v
          +------------+
          |    MON     |    â† Monitor: Quáº£n lÃ½ tráº¡ng thÃ¡i cluster
          +------------+
               |
               | 2. Tráº£ vá» thÃ´ng tin MDS
               v
          +------------+
          |    MDS     |    â† Metadata Server: Tra cá»©u file
          +------------+
               |
               | 3. Tráº£ vá» vá»‹ trÃ­ block cá»§a file `report.pdf`
               v
    +-----------+   +-----------+   +-----------+
    |   OSD 1   |   |   OSD 2   |   |   OSD 3   |   â† Object Storage Daemon: chá»©a dá»¯ liá»‡u tháº­t
    +-----------+   +-----------+   +-----------+
               |         |               |
               +-------> Client Ä‘á»c dá»¯ liá»‡u trá»±c tiáº¿p

```
ğŸ§  Äiá»u quan trá»ng:
- Má»—i block cá»§a file lÃ  má»™t object trong RADOS, Ä‘Æ°á»£c lÆ°u Ä‘á»™c láº­p
- MDS chá»‰ tráº£ vá» metadata (mapping), cÃ²n viá»‡c gom block láº¡i thÃ nh file lÃ  nhiá»‡m vá»¥ cá»§a client-side CephFS kernel hoáº·c librados client
- File khÃ´ng Ä‘Æ°á»£c "gom láº¡i thÃ nh 1 khá»‘i" trÃªn OSD â€“ mÃ  váº«n phÃ¢n máº£nh ra nhiá»u object ráº£i rÃ¡c

---

## CÆ¡ cháº¿ quan trá»ng

### 1. LÆ°u trá»¯ dá»¯ liá»‡u thá»±c táº¿

{/* - File Ä‘Æ°á»£c chia nhá» thÃ nh nhiá»u block vÃ  lÆ°u trÃªn nhiá»u **OSD (Object Storage Daemon)** khÃ¡c nhau.
- Dá»¯ liá»‡u cÃ³ thá»ƒ phÃ¢n tÃ¡n trÃªn nhiá»u á»• cá»©ng váº­t lÃ½. */}
- OSD lÃ  thÃ nh pháº§n trong Ceph dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u tháº­t sá»± - tá»©c lÃ  nÆ¡i file cá»§a báº¡n â€œsá»‘ngâ€ tháº­t.
- LÃ  má»™t dá»‹ch vá»¥ cháº¡y trÃªn mÃ¡y chá»§ (daemon).
- Gáº¯n liá»n vá»›i má»™t á»• Ä‘Ä©a váº­t lÃ½ hoáº·c partition.
- Má»™t node cÃ³ thá»ƒ cháº¡y nhiá»u OSD, má»—i OSD cho má»™t á»• Ä‘Ä©a khÃ¡c nhau.
- ğŸ”§ VÃ­ dá»¥: Náº¿u 1 mÃ¡y cÃ³ 4 á»• cá»©ng â†’ cÃ³ thá»ƒ cháº¡y 4 OSD.

ğŸ“¦ VÃ­ dá»¥ dá»… hiá»ƒu:
File report.pdf cÃ³ dung lÆ°á»£ng 12MB. Ceph chia file nÃ y thÃ nh 3 block (má»—i block 4MB).

   - Block 1 â†’ lÆ°u á»Ÿ OSD1
   - Block 2 â†’ lÆ°u á»Ÿ OSD2 
   - Block 3 â†’ lÆ°u á»Ÿ OSD3
- Má»—i block sáº½ Ä‘Æ°á»£c sao lÆ°u (replica) sang 2 OSD khÃ¡c ná»¯a.
- Tá»•ng cá»™ng: 3 block Ã— 3 replica = 9 báº£n nhá» Ä‘Æ°á»£c lÆ°u ráº£i rÃ¡c.

```
             +----------------------+
             |   File: report.pdf   |  (12 MB)
             +----------------------+
                        |
                        |  Chia thÃ nh 3 block (4 MB má»—i block)
                        v
        +----------+    +----------+    +----------+
        | Block 1  |    | Block 2  |    | Block 3  |
        +----------+    +----------+    +----------+
             |               |               |
             |               |               |
             v               v               v
      +------------+   +------------+   +------------+
      |   OSD 1    |   |   OSD 2    |   |   OSD 3    |
      +------------+   +------------+   +------------+
             |               |               |
     (Replica 1 & 2)  (Replica 1 & 2)  (Replica 1 & 2)
             |               |               |
             v               v               v
      +------------+   +------------+   +------------+
      |   OSD 4    |   |   OSD 5    |   |   OSD 6    |
      +------------+   +------------+   +------------+
```

### 2. Tá»± Ä‘á»™ng sao lÆ°u (Replication)

Ceph sá»­ dá»¥ng thuáº­t toÃ¡n CRUSH vÃ  cÆ¡ cháº¿ primary OSD replication Ä‘á»ƒ thá»±c hiá»‡n tá»± Ä‘á»™ng sao lÆ°u dá»¯ liá»‡u giá»¯a cÃ¡c OSD.
NÃ³ khÃ´ng dÃ¹ng rsync, khÃ´ng dÃ¹ng snapshot, khÃ´ng copy tá»«ng file, mÃ  lÃ m á»Ÿ táº§ng object (block), hoÃ n toÃ n phÃ¢n tÃ¡n vÃ  theo quy táº¯c Ä‘á»“ng bá»™ hÃ³a Ä‘á»“ng thuáº­n.

```
                         +------------+
                         |  Client    |
                         +------------+
                               |
                               | 1ï¸âƒ£ Gá»­i block dá»¯ liá»‡u (VD: Block 42)
                               v
                       +------------------+
                       |   Primary OSD     |  â† OSD1 (Ä‘Æ°á»£c CRUSH chá»n lÃ  chÃ­nh)
                       +------------------+
                         |          |
            2ï¸âƒ£ Gá»­i replica     2ï¸âƒ£ Gá»­i replica
                         |          |
                         v          v
                +-------------+   +-------------+
                |  Replica OSD |   |  Replica OSD |
                |   (OSD2)     |   |   (OSD3)     |
                +-------------+   +-------------+

                         ^           ^
                         |           |
       3ï¸âƒ£ Gá»­i xÃ¡c nháº­n ----       ---- 3ï¸âƒ£ Gá»­i xÃ¡c nháº­n
                         \         /
                          \       /
                       +------------------+
                       |  Primary OSD      |
                       | (nháº­n Ä‘á»§ ACK)     |
                       +------------------+
                               |
         4ï¸âƒ£ BÃ¡o "Ghi thÃ nh cÃ´ng" cho client
                               v
                         +------------+
                         |  Client    |
                         +------------+
```
1. CRUSH chá»n OSDs: Khi cáº§n ghi 1 block, Ceph dÃ¹ng thuáº­t toÃ¡n CRUSH Ä‘á»ƒ tÃ­nh ra danh sÃ¡ch cÃ¡c OSD sáº½ lÆ°u:
- VÃ­ dá»¥: OSD1 (chÃ­nh), OSD2 (replica 1), OSD3 (replica 2)

2. Primary OSD nháº­n ghi: Client gá»­i block Ä‘áº¿n Primary OSD (OSD1).
- OSD1 sáº½ gá»­i block Ä‘Ã³ Ä‘á»“ng thá»i Ä‘áº¿n cÃ¡c OSD khÃ¡c (OSD2, OSD3).

3. CÆ¡ cháº¿ Ä‘á»“ng bá»™ kiá»ƒu â€œWrite-Ackâ€: OSD1 chá» pháº£n há»“i tá»« OSD2, OSD3 â†’ khi Ä‘á»§ sá»‘ lÆ°á»£ng replica pháº£n há»“i thÃ nh cÃ´ng â†’ má»›i bÃ¡o cho client lÃ  â€œghi hoÃ n táº¥tâ€.
- ÄÃ¢y gá»i lÃ  quorum-style acknowledgment.

4. Consistency Ä‘áº£m báº£o á»Ÿ má»©c object: Tá»«ng block Ä‘Æ°á»£c Ä‘á»“ng bá»™ riÃªng biá»‡t, khÃ´ng cáº§n nháº¥t quÃ¡n toÃ n há»‡ thá»‘ng nhÆ° database.


### 3. PhÃ¢n táº£i & sáºµn sÃ ng cao (High Availability)

ğŸ‘‰ DÆ°á»›i Ä‘Ã¢y lÃ  mÃ´ hÃ¬nh kiáº¿n trÃºc riÃªng cá»§a CephFS, thá»ƒ hiá»‡n rÃµ:

- CÃ¡ch hoáº¡t Ä‘á»™ng cá»§a HA & phÃ¢n táº£i
- Vai trÃ² cá»§a tá»«ng thÃ nh pháº§n: Client, MON, MGR, MDS, OSD
- KhÃ´ng cÃ³ Ä‘iá»ƒm lá»—i Ä‘Æ¡n láº» (No SPOF)


```
                                   +------------------+
                                   |    Client A      | â† App / User / Pod
                                   +------------------+
                                           |
                               Mount CephFS qua kernel/FUSE
                                           |
                   +-----------------------+-----------------------+
                   |                       |                       |
                   v                       v                       v
             +-----------+         +-----------+         +-----------+
             |   MON 1   |         |   MON 2   |         |   MON 3   | â† Quorum MON: â‰¥2/3
             +-----------+         +-----------+         +-----------+
                   |                     |                     |
                   +----------------+-------------------------+
                                    |
                        +------------------------+
                        |     MGR Active / HA     | â† Theo dÃµi MON, MDS, OSD, health
                        +------------------------+

                                    â†“
                +-------------------------------------------+
                |         CephFS Metadata Servers           |
                |    (MDS Active + MDS Standby nodes)       |
                +-------------------------------------------+
                  |                        |
           +---------------+     +------------------+
           |   MDS Active  |     |   MDS Standby    | â† Auto failover náº¿u Active cháº¿t
           +---------------+     +------------------+
                  |
        [Metadata: file path, inode, quyá»n, mapping]
                  |
                  v
   +----------------+   +----------------+   +----------------+
   |     OSD 1      |   |     OSD 2      |   |     OSD 3      | â† Dá»¯ liá»‡u file (block)
   +----------------+   +----------------+   +----------------+
         |  |                   |  |                  |  |
         |  +--- Replica 1 ---> |  +--- Replica 2 --->| ...
         |                      |                     |
         |<----- Load Balancing + Recovery ---------->|

```
#### ğŸ§© Diá»…n giáº£i cÆ¡ cháº¿ High Availability trong CephFS

```

| ThÃ nh pháº§n | CÆ¡ cháº¿ HA |
|------------|-----------|
| **MON**    | Tá»‘i thiá»ƒu 3 MON Ä‘á»ƒ Ä‘áº¡t quorum (2/3) |
| **MDS**    | Há»— trá»£ Active/Standby hoáº·c Active/Active MDS |
| **OSD**    | Dá»¯ liá»‡u Ä‘Æ°á»£c chia block + replica trÃªn nhiá»u OSD |
| **Client** | Tá»± Ä‘á»™ng reconnect sang MDS khÃ¡c khi fail |
| **MGR**    | GiÃ¡m sÃ¡t toÃ n cluster, kÃ­ch hoáº¡t cáº£nh bÃ¡o, plugin |

```
#### ğŸ”„ CÆ¡ cháº¿ Load Balancing trong CephFS

| Táº§ng            | CÆ¡ cháº¿ |
|------------------|--------|
| **Client â†’ MDS** | Client Ä‘Æ°á»£c phÃ¢n vÃ o cÃ¡c MDS theo subtree, náº¿u cÃ³ nhiá»u MDS Active |
| **Dá»¯ liá»‡u â†’ OSD** | CRUSH tá»± Ä‘á»™ng phÃ¢n phá»‘i block Ä‘á»u lÃªn OSD theo trá»ng sá»‘ |
| **DÃ²ng truy cáº­p** | TrÃ¡nh â€œnÃ³ngâ€ 1 OSD nhá» CRUSH vÃ  pool tuning |

#### âš ï¸ Khi cÃ³ sá»± cá»‘ â€“ CephFS xá»­ lÃ½ tháº¿ nÃ o?
| TÃ¬nh huá»‘ng         | CephFS xá»­ lÃ½ |
|--------------------|--------------|
| **MDS Active cháº¿t** | Standby tá»± Ä‘á»™ng takeover |
| **MON cháº¿t**        | Miá»…n cÃ²n quorum, client váº«n mount Ä‘Æ°á»£c |
| **OSD cháº¿t**        | Ceph tá»± sá»­ dá»¥ng báº£n replica khÃ¡c Ä‘á»ƒ phá»¥c vá»¥ |
| **Node máº¥t Ä‘iá»‡n**   | Ceph tá»± rebalancing + backfill dá»¯ liá»‡u sau khi node trá»Ÿ láº¡i |

### 4. Má»Ÿ rá»™ng tá»± Ä‘á»™ng
Gáº¯n thÃªm á»• cá»©ng/node má»›i â†’ Ceph tá»± Ä‘á»™ng thÃªm vÃ o há»‡ thá»‘ng, khÃ´ng cáº§n dá»«ng há»‡ thá»‘ng.
CephFS cÃ³ kháº£ nÄƒng má»Ÿ rá»™ng tá»± Ä‘á»™ng vÃ  gáº§n nhÆ° khÃ´ng giá»›i háº¡n, nhá» vÃ o:
- ğŸ“‚ Má»Ÿ rá»™ng metadata layer (MDS)
- ğŸ’¾ Má»Ÿ rá»™ng storage layer (OSD)
- ğŸ“ˆ Tá»± Ä‘á»™ng phÃ¢n phá»‘i táº£i client / dá»¯ liá»‡u / metadata
```
                +-----------------+      +-----------------+
                |    MDS 1        |      |    MDS 2        | â† Active/Active MDS
                +-----------------+      +-----------------+
                         |                       |
                         | Metadata Subtree A    | Metadata Subtree B
                         v                       v
                +-------------+          +-------------+
                |   OSD 1     |   ...    |   OSD n     | â† Storage má»Ÿ rá»™ng khÃ´ng giá»›i háº¡n
                +-------------+          +-------------+

                       â†‘
              Ceph tá»± Ä‘á»™ng rebalancing
              khi thÃªm OSD / tÄƒng táº£i

                    â†•
        Client tá»± gÃ¡n vÃ o MDS / OSD phÃ¹ há»£p

```

---
## Káº¿t luáº­n
CephFS lÃ  má»™t há»‡ thá»‘ng tá»‡p phÃ¢n tÃ¡n máº¡nh máº½, linh hoáº¡t vÃ  tá»± Ä‘á»™ng phá»¥c há»“i. NÃ³ cho phÃ©p nhiá»u ngÆ°á»i dÃ¹ng truy cáº­p vÃ  chia sáº» dá»¯ liá»‡u má»™t cÃ¡ch dá»… dÃ ng, Ä‘á»“ng thá»i Ä‘áº£m báº£o an toÃ n vÃ  kháº£ nÄƒng má»Ÿ rá»™ng cao. CephFS lÃ  lá»±a chá»n lÃ½ tÆ°á»Ÿng cho cÃ¡c á»©ng dá»¥ng yÃªu cáº§u lÆ°u trá»¯ file lá»›n vÃ  phÃ¢n tÃ¡n.
