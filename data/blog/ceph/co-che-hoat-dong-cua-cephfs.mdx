---
title: 'C∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa CephFS'
description: 'Gi·ªõi thi·ªáu v·ªÅ CephFS - h·ªá th·ªëng t·ªáp ph√¢n t√°n m·∫°nh m·∫Ω v√† linh ho·∫°t'
date: '2024-03-18'
tags: ['Cloudnative', 'Storage', 'Ceph']
authors: ['bachdangtuan']
---

# C∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa CephFS

## üìë M·ª•c L·ª•c

1. [CephFS](#ceph)
2. [C√°ch th·ª©c ho·∫°t ƒë·ªông CephFS](#cach-thuc-hoat-dong-ceph)
3. [C∆° ch·∫ø quan tr·ªçng c·ªßa CEPH](#co-che-quan-trong)
   - [L∆∞u tr·ªØ d·ªØ li·ªáu th·ª±c t·∫ø](#luu-tru-du-lieu-thuc-te)
   - [T·ª± ƒë·ªông sao l∆∞u (Replication)](#tu-dong-sao-luu)
   - [Ph√¢n t·∫£i & s·∫µn s√†ng cao (High Availability)](#ha)
   - [M·ªü r·ªông t·ª± ƒë·ªông](#mo-rong)
4. [K·∫øt lu·∫≠n](#ket-luan)

<h2 id="ceph">üß∞ CephFS?</h2>

**CephFS (Ceph File System)** l√† m·ªôt h·ªá th·ªëng **l∆∞u tr·ªØ file ph√¢n t√°n** ho·∫°t ƒë·ªông t∆∞∆°ng t·ª± nh∆∞:

- M·ªôt **·ªï ƒëƒ©a m·∫°ng (shared drive)**, n∆°i nhi·ªÅu m√°y t√≠nh ho·∫∑c ·ª©ng d·ª•ng c√≥ th·ªÉ truy c·∫≠p c√πng l√∫c.
- Nh∆∞ng kh√°c ·ªü ch·ªó: d·ªØ li·ªáu ƒë∆∞·ª£c **l∆∞u tr√™n nhi·ªÅu ·ªï ƒëƒ©a, nhi·ªÅu m√°y ch·ªß**, c√≥ kh·∫£ nƒÉng **ph√¢n t√°n, sao l∆∞u v√† t·ª± ph·ª•c h·ªìi**.

---

<h2 id="cach-thuc-hoat-dong-ceph">üß∞ C√°ch th·ª©c ho·∫°t ƒë·ªông CephFS</h2>
Ng∆∞·ªùi d√πng (Client A) l∆∞u file /docs/report.pdf v√†o trong CephFS. #### üì• C√°c b∆∞·ªõc ng∆∞·ªùi upload v√†
l∆∞u d·ªØ li·ªáu:

1. Client mount CephFS ‚Üí li√™n h·ªá MON ƒë·ªÉ bi·∫øt th√¥ng tin cluster.
2. MON tr·∫£ v·ªÅ danh s√°ch c√°c th√†nh ph·∫ßn ƒëang active, bao g·ªìm MDS.
3. Client g·ª≠i y√™u c·∫ßu t·∫°o file m·ªõi t·ªõi MDS.
4. MDS t·∫°o entry metadata cho file m·ªõi, g√°n inode, quy·ªÅn truy c·∫≠p, ƒë∆∞·ªùng d·∫´n.
5. File ƒë∆∞·ª£c chia th√†nh c√°c block nh·ªè (th∆∞·ªùng 4MB m·ªói block).
6. M·ªói block ƒë∆∞·ª£c g√°n Object ID v√† l∆∞u tr·ªØ ph√¢n t√°n l√™n c√°c OSD kh√°c nhau.
7. M·ªói block ƒë∆∞·ª£c replica (m·∫∑c ƒë·ªãnh 3 b·∫£n) ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu.
8. MDS c·∫≠p nh·∫≠t metadata, l∆∞u th√¥ng tin v·ªÅ c√°c block v√† v·ªã tr√≠ c·ªßa ch√∫ng.
9. Sau khi d·ªØ li·ªáu v√† metadata ƒë·ªÅu ƒë∆∞·ª£c commit th√†nh c√¥ng, client nh·∫≠n ph·∫£n h·ªìi ‚Äúghi th√†nh c√¥ng‚Äù.

```
                     [1] Client A mount CephFS ‚Üí h·ªèi MON
                                 |
                                 v
                            +--------+
                            |  MON   |  ‚Üê Monitor: Qu·∫£n l√Ω cluster map, quorum
                            +--------+
                                 |
                     [2] Tr·∫£ v·ªÅ MDS ƒëang active
                                 |
                                 v
                            +--------+
                            |  MDS   |  ‚Üê Metadata Server: Qu·∫£n l√Ω inode, quy·ªÅn, ƒë∆∞·ªùng d·∫´n
                            +--------+
                                 |
         [3] G·ª≠i y√™u c·∫ßu t·∫°o file /docs/report.pdf (metadata)
                                 |
         [4] Chia nh·ªè file th√†nh c√°c block (VD: 4MB m·ªói block)
                                 |
                                 v
      +-----------+    +-----------+    +-----------+
      |   OSD 1   |    |   OSD 2   |    |   OSD 3   |   ‚Üê L∆∞u block d·ªØ li·ªáu th·ª±c t·∫ø
      +-----------+    +-----------+    +-----------+
           |                |                |
           |<---- Replication copies ------->|  ‚Üê T·ª± ƒë·ªông sao l∆∞u block (replica)

                              ‚Üë
                              |
                       +-------------+
                       |     MGR     |  ‚Üê Manager: Theo d√µi MON, MDS, OSD, plugin, alerts
                       +-------------+
```

Ng∆∞·ªùi d√πng (Client A) m·ªü file `/docs/report.pdf` ƒë∆∞·ª£c l∆∞u tr·ªØ trong CephFS.

#### üì• C√°c b∆∞·ªõc ng∆∞·ªùi d√πng l·∫•y d·ªØ li·ªáu:

            1. **Client A** y√™u c·∫ßu m·ªü file `report.pdf`.
            2. Client li√™n h·ªá MON ƒë·ªÉ l·∫•y th√¥ng tin v·ªÅ cluster + MDS hi·ªán t·∫°i.
            3. MON tr·∫£ v·ªÅ danh s√°ch MDS (ƒë·∫∑c bi·ªát l√† MDS ƒëang active).
            4. Client g·ª≠i y√™u c·∫ßu t·ªõi MDS ƒë·ªÉ l·∫•y th√¥ng tin v·ªÅ file.
            5. MDS tr·∫£ v·ªÅ th√¥ng tin v·ªÅ file: `report.pdf` n·∫±m ·ªü ƒë√¢u, tr√™n OSD n√†o.
            6. Client nh·∫≠n th√¥ng tin ‚Üí k·∫øt n·ªëi tr·ª±c ti·∫øp t·ªõi c√°c OSD ch·ª©a d·ªØ li·ªáu th·∫≠t.
            7. Client g·ª≠i y√™u c·∫ßu t·ªõi OSD ƒë·ªÉ l·∫•y d·ªØ li·ªáu.
            8. OSD tr·∫£ v·ªÅ d·ªØ li·ªáu cho Client.
            9. N·∫øu 1 OSD b·ªã l·ªói, Ceph t·ª± d√πng b·∫£n sao t·ª´ OSD kh√°c (replica).
            10.N·∫øu c√≥ nhi·ªÅu client, MDS + MON ph√¢n ph·ªëi t·∫£i h·ª£p l√Ω.

```
          +------------+
          |  Client A  |
          +------------+
               |
               | 1. G·ª≠i y√™u c·∫ßu mount CephFS
               v
          +------------+
          |    MON     |    ‚Üê Monitor: Qu·∫£n l√Ω tr·∫°ng th√°i cluster
          +------------+
               |
               | 2. Tr·∫£ v·ªÅ th√¥ng tin MDS
               v
          +------------+
          |    MDS     |    ‚Üê Metadata Server: Tra c·ª©u file
          +------------+
               |
               | 3. Tr·∫£ v·ªÅ v·ªã tr√≠ block c·ªßa file `report.pdf`
               v
    +-----------+   +-----------+   +-----------+
    |   OSD 1   |   |   OSD 2   |   |   OSD 3   |   ‚Üê Object Storage Daemon: ch·ª©a d·ªØ li·ªáu th·∫≠t
    +-----------+   +-----------+   +-----------+
               |         |               |
               +-------> Client ƒë·ªçc d·ªØ li·ªáu tr·ª±c ti·∫øp

```

üß† ƒêi·ªÅu quan tr·ªçng:

- M·ªói block c·ªßa file l√† m·ªôt object trong RADOS, ƒë∆∞·ª£c l∆∞u ƒë·ªôc l·∫≠p
- MDS ch·ªâ tr·∫£ v·ªÅ metadata (mapping), c√≤n vi·ªác gom block l·∫°i th√†nh file l√† nhi·ªám v·ª• c·ªßa client-side CephFS kernel ho·∫∑c librados client
- File kh√¥ng ƒë∆∞·ª£c "gom l·∫°i th√†nh 1 kh·ªëi" tr√™n OSD ‚Äì m√† v·∫´n ph√¢n m·∫£nh ra nhi·ªÅu object r·∫£i r√°c

---

<h2 id="co-che-quan-trong">üß∞ C∆° ch·∫ø quan tr·ªçng</h2>

<h3 id="luu-tru-du-lieu-thuc-te">üß∞ L∆∞u tr·ªØ d·ªØ li·ªáu th·ª±c t·∫ø</h3>- OSD l√† th√†nh ph·∫ßn trong Ceph d√πng
ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu th·∫≠t s·ª± - t·ª©c l√† n∆°i file c·ªßa b·∫°n ‚Äús·ªëng‚Äù th·∫≠t. - L√† m·ªôt d·ªãch v·ª• ch·∫°y tr√™n m√°y ch·ªß
(daemon). - G·∫Øn li·ªÅn v·ªõi m·ªôt ·ªï ƒëƒ©a v·∫≠t l√Ω ho·∫∑c partition. - M·ªôt node c√≥ th·ªÉ ch·∫°y nhi·ªÅu OSD, m·ªói OSD
cho m·ªôt ·ªï ƒëƒ©a kh√°c nhau. - üîß V√≠ d·ª•: N·∫øu 1 m√°y c√≥ 4 ·ªï c·ª©ng ‚Üí c√≥ th·ªÉ ch·∫°y 4 OSD.

üì¶ V√≠ d·ª• d·ªÖ hi·ªÉu:
File report.pdf c√≥ dung l∆∞·ª£ng 12MB. Ceph chia file n√†y th√†nh 3 block (m·ªói block 4MB).

- Block 1 ‚Üí l∆∞u ·ªü OSD1
- Block 2 ‚Üí l∆∞u ·ªü OSD2
- Block 3 ‚Üí l∆∞u ·ªü OSD3
- M·ªói block s·∫Ω ƒë∆∞·ª£c sao l∆∞u (replica) sang 2 OSD kh√°c n·ªØa.
- T·ªïng c·ªông: 3 block √ó 3 replica = 9 b·∫£n nh·ªè ƒë∆∞·ª£c l∆∞u r·∫£i r√°c.

```
             +----------------------+
             |   File: report.pdf   |  (12 MB)
             +----------------------+
                        |
                        |  Chia th√†nh 3 block (4 MB m·ªói block)
                        v
        +----------+    +----------+    +----------+
        | Block 1  |    | Block 2  |    | Block 3  |
        +----------+    +----------+    +----------+
             |               |               |
             |               |               |
             v               v               v
      +------------+   +------------+   +------------+
      |   OSD 1    |   |   OSD 2    |   |   OSD 3    |
      +------------+   +------------+   +------------+
             |               |               |
     (Replica 1 & 2)  (Replica 1 & 2)  (Replica 1 & 2)
             |               |               |
             v               v               v
      +------------+   +------------+   +------------+
      |   OSD 4    |   |   OSD 5    |   |   OSD 6    |
      +------------+   +------------+   +------------+
```

<h3 id="tu-dong-sao-luu">üß∞ T·ª± ƒë·ªông sao l∆∞u</h3>

Ceph s·ª≠ d·ª•ng thu·∫≠t to√°n CRUSH v√† c∆° ch·∫ø primary OSD replication ƒë·ªÉ th·ª±c hi·ªán t·ª± ƒë·ªông sao l∆∞u d·ªØ li·ªáu gi·ªØa c√°c OSD.
N√≥ kh√¥ng d√πng rsync, kh√¥ng d√πng snapshot, kh√¥ng copy t·ª´ng file, m√† l√†m ·ªü t·∫ßng object (block), ho√†n to√†n ph√¢n t√°n v√† theo quy t·∫Øc ƒë·ªìng b·ªô h√≥a ƒë·ªìng thu·∫≠n.

```
                         +------------+
                         |  Client    |
                         +------------+
                               |
                               | 1Ô∏è‚É£ G·ª≠i block d·ªØ li·ªáu (VD: Block 42)
                               v
                       +------------------+
                       |   Primary OSD     |  ‚Üê OSD1 (ƒë∆∞·ª£c CRUSH ch·ªçn l√† ch√≠nh)
                       +------------------+
                         |          |
            2Ô∏è‚É£ G·ª≠i replica     2Ô∏è‚É£ G·ª≠i replica
                         |          |
                         v          v
                +-------------+   +-------------+
                |  Replica OSD |   |  Replica OSD |
                |   (OSD2)     |   |   (OSD3)     |
                +-------------+   +-------------+

                         ^           ^
                         |           |
       3Ô∏è‚É£ G·ª≠i x√°c nh·∫≠n ----       ---- 3Ô∏è‚É£ G·ª≠i x√°c nh·∫≠n
                         \         /
                          \       /
                       +------------------+
                       |  Primary OSD      |
                       | (nh·∫≠n ƒë·ªß ACK)     |
                       +------------------+
                               |
         4Ô∏è‚É£ B√°o "Ghi th√†nh c√¥ng" cho client
                               v
                         +------------+
                         |  Client    |
                         +------------+
```

1. CRUSH ch·ªçn OSDs: Khi c·∫ßn ghi 1 block, Ceph d√πng thu·∫≠t to√°n CRUSH ƒë·ªÉ t√≠nh ra danh s√°ch c√°c OSD s·∫Ω l∆∞u:

- V√≠ d·ª•: OSD1 (ch√≠nh), OSD2 (replica 1), OSD3 (replica 2)

2. Primary OSD nh·∫≠n ghi: Client g·ª≠i block ƒë·∫øn Primary OSD (OSD1).

- OSD1 s·∫Ω g·ª≠i block ƒë√≥ ƒë·ªìng th·ªùi ƒë·∫øn c√°c OSD kh√°c (OSD2, OSD3).

3. C∆° ch·∫ø ƒë·ªìng b·ªô ki·ªÉu ‚ÄúWrite-Ack‚Äù: OSD1 ch·ªù ph·∫£n h·ªìi t·ª´ OSD2, OSD3 ‚Üí khi ƒë·ªß s·ªë l∆∞·ª£ng replica ph·∫£n h·ªìi th√†nh c√¥ng ‚Üí m·ªõi b√°o cho client l√† ‚Äúghi ho√†n t·∫•t‚Äù.

- ƒê√¢y g·ªçi l√† quorum-style acknowledgment.

4. Consistency ƒë·∫£m b·∫£o ·ªü m·ª©c object: T·ª´ng block ƒë∆∞·ª£c ƒë·ªìng b·ªô ri√™ng bi·ªát, kh√¥ng c·∫ßn nh·∫•t qu√°n to√†n h·ªá th·ªëng nh∆∞ database.

<h3 id="ha">üß∞ Ph√¢n t·∫£i & s·∫µn s√†ng cao</h3>
üëâ D∆∞·ªõi ƒë√¢y l√† m√¥ h√¨nh ki·∫øn tr√∫c ri√™ng c·ªßa CephFS, th·ªÉ hi·ªán r√µ:

- C√°ch ho·∫°t ƒë·ªông c·ªßa HA & ph√¢n t·∫£i
- Vai tr√≤ c·ªßa t·ª´ng th√†nh ph·∫ßn: Client, MON, MGR, MDS, OSD
- Kh√¥ng c√≥ ƒëi·ªÉm l·ªói ƒë∆°n l·∫ª (No SPOF)

```
                                   +------------------+
                                   |    Client A      | ‚Üê App / User / Pod
                                   +------------------+
                                           |
                               Mount CephFS qua kernel/FUSE
                                           |
                   +-----------------------+-----------------------+
                   |                       |                       |
                   v                       v                       v
             +-----------+         +-----------+         +-----------+
             |   MON 1   |         |   MON 2   |         |   MON 3   | ‚Üê Quorum MON: ‚â•2/3
             +-----------+         +-----------+         +-----------+
                   |                     |                     |
                   +----------------+-------------------------+
                                    |
                        +------------------------+
                        |     MGR Active / HA     | ‚Üê Theo d√µi MON, MDS, OSD, health
                        +------------------------+

                                    ‚Üì
                +-------------------------------------------+
                |         CephFS Metadata Servers           |
                |    (MDS Active + MDS Standby nodes)       |
                +-------------------------------------------+
                  |                        |
           +---------------+     +------------------+
           |   MDS Active  |     |   MDS Standby    | ‚Üê Auto failover n·∫øu Active ch·∫øt
           +---------------+     +------------------+
                  |
        [Metadata: file path, inode, quy·ªÅn, mapping]
                  |
                  v
   +----------------+   +----------------+   +----------------+
   |     OSD 1      |   |     OSD 2      |   |     OSD 3      | ‚Üê D·ªØ li·ªáu file (block)
   +----------------+   +----------------+   +----------------+
         |  |                   |  |                  |  |
         |  +--- Replica 1 ---> |  +--- Replica 2 --->| ...
         |                      |                     |
         |<----- Load Balancing + Recovery ---------->|

```

#### üß© Di·ªÖn gi·∫£i c∆° ch·∫ø High Availability trong CephFS

```

| Th√†nh ph·∫ßn | C∆° ch·∫ø HA |
|------------|-----------|
| **MON**    | T·ªëi thi·ªÉu 3 MON ƒë·ªÉ ƒë·∫°t quorum (2/3) |
| **MDS**    | H·ªó tr·ª£ Active/Standby ho·∫∑c Active/Active MDS |
| **OSD**    | D·ªØ li·ªáu ƒë∆∞·ª£c chia block + replica tr√™n nhi·ªÅu OSD |
| **Client** | T·ª± ƒë·ªông reconnect sang MDS kh√°c khi fail |
| **MGR**    | Gi√°m s√°t to√†n cluster, k√≠ch ho·∫°t c·∫£nh b√°o, plugin |

```

#### üîÑ C∆° ch·∫ø Load Balancing trong CephFS

| T·∫ßng              | C∆° ch·∫ø                                                             |
| ----------------- | ------------------------------------------------------------------ |
| **Client ‚Üí MDS**  | Client ƒë∆∞·ª£c ph√¢n v√†o c√°c MDS theo subtree, n·∫øu c√≥ nhi·ªÅu MDS Active |
| **D·ªØ li·ªáu ‚Üí OSD** | CRUSH t·ª± ƒë·ªông ph√¢n ph·ªëi block ƒë·ªÅu l√™n OSD theo tr·ªçng s·ªë            |
| **D√≤ng truy c·∫≠p** | Tr√°nh ‚Äún√≥ng‚Äù 1 OSD nh·ªù CRUSH v√† pool tuning                        |

#### ‚ö†Ô∏è Khi c√≥ s·ª± c·ªë ‚Äì CephFS x·ª≠ l√Ω th·∫ø n√†o?

| T√¨nh hu·ªëng          | CephFS x·ª≠ l√Ω                                                |
| ------------------- | ----------------------------------------------------------- |
| **MDS Active ch·∫øt** | Standby t·ª± ƒë·ªông takeover                                    |
| **MON ch·∫øt**        | Mi·ªÖn c√≤n quorum, client v·∫´n mount ƒë∆∞·ª£c                      |
| **OSD ch·∫øt**        | Ceph t·ª± s·ª≠ d·ª•ng b·∫£n replica kh√°c ƒë·ªÉ ph·ª•c v·ª•                 |
| **Node m·∫•t ƒëi·ªán**   | Ceph t·ª± rebalancing + backfill d·ªØ li·ªáu sau khi node tr·ªü l·∫°i |

<h3 id="mo-rong">üß∞ M·ªü r·ªông t·ª± ƒë·ªông</h3>
G·∫Øn th√™m ·ªï c·ª©ng/node m·ªõi ‚Üí Ceph t·ª± ƒë·ªông th√™m v√†o h·ªá th·ªëng, kh√¥ng c·∫ßn d·ª´ng h·ªá th·ªëng. CephFS c√≥ kh·∫£
nƒÉng m·ªü r·ªông t·ª± ƒë·ªông v√† g·∫ßn nh∆∞ kh√¥ng gi·ªõi h·∫°n, nh·ªù v√†o: - üìÇ M·ªü r·ªông metadata layer (MDS) - üíæ M·ªü
r·ªông storage layer (OSD) - üìà T·ª± ƒë·ªông ph√¢n ph·ªëi t·∫£i client / d·ªØ li·ªáu / metadata ```
+-----------------+ +-----------------+ | MDS 1 | | MDS 2 | ‚Üê Active/Active MDS +-----------------+
+-----------------+ | | | Metadata Subtree A | Metadata Subtree B v v +-------------+
+-------------+ | OSD 1 | ... | OSD n | ‚Üê Storage m·ªü r·ªông kh√¥ng gi·ªõi h·∫°n +-------------+
+-------------+

                       ‚Üë
              Ceph t·ª± ƒë·ªông rebalancing
              khi th√™m OSD / tƒÉng t·∫£i

                    ‚Üï
        Client t·ª± g√°n v√†o MDS / OSD ph√π h·ª£p

```

---
<h2 id="ket-luan">üß∞ T·ª± ƒë·ªông sao l∆∞u</h2>
CephFS l√† m·ªôt h·ªá th·ªëng t·ªáp ph√¢n t√°n m·∫°nh m·∫Ω, linh ho·∫°t v√† t·ª± ƒë·ªông ph·ª•c h·ªìi. N√≥ cho ph√©p nhi·ªÅu ng∆∞·ªùi d√πng truy c·∫≠p v√† chia s·∫ª d·ªØ li·ªáu m·ªôt c√°ch d·ªÖ d√†ng, ƒë·ªìng th·ªùi ƒë·∫£m b·∫£o an to√†n v√† kh·∫£ nƒÉng m·ªü r·ªông cao. CephFS l√† l·ª±a ch·ªçn l√Ω t∆∞·ªüng cho c√°c ·ª©ng d·ª•ng y√™u c·∫ßu l∆∞u tr·ªØ file l·ªõn v√† ph√¢n t√°n.
```
