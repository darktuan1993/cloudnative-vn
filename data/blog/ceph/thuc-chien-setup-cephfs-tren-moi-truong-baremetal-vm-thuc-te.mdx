---
title: '[Th·ª±c chi·∫øn]-H∆∞·ªõng d·∫´n Setup CephFS tr√™n m√¥i tr∆∞·ªùng BareMetal / VM th·ª±c t·∫ø'
description: '[Th·ª±c chi·∫øn]-H∆∞·ªõng d·∫´n Setup CephFS tr√™n m√¥i tr∆∞·ªùng th·ª±c t·∫ø'
date: '2021-05-18'
tags: ['Cloudnative', 'Storage', 'CephFS']
authors: ['bachdangtuan']
summary: '[Th·ª±c chi·∫øn]-h∆∞·ªõng d·∫´n tri·ªÉn khai c√†i ƒë·∫∑t ceph trong m√¥i tr∆∞·ªùng th·ª±c t·∫ø mang ra ch·∫°y production ngon l√†nh'
---

# Setup CephFS tr√™n m√¥i tr∆∞·ªùng th·ª±c t·∫ø

ƒê·ªÉ tri·ªÉn khai cephFS trong m√¥i tr∆∞·ªùng th·ª±c t·∫ø th√¨ ch√∫ng ta c·∫ßn chu·∫©n b·ªã nh∆∞ sau:

## üìë M·ª•c L·ª•c

1. [Chu·∫©n b·ªã](#chuan-bi-may-chu)
   - [C·∫•u h√¨nh m√°y ch·ªß](#cau-hinh-may-chu)
   - [M√¥ h√¨nh thi·∫øt k·∫ø](#mo-hinh-thiet-ke)
2. [Tuning OS h·ªá th·ªëng](#tuning-os-he-thong)
3. [C√†i ƒë·∫∑t h·ªá th·ªëng CephFS](#cai-dat-ceph)
4. [K·ªãch b·∫£n m·ªü r·ªông h·ªá th·ªëng](#mo-rong-he-thong)
5. [K·ªãch b·∫£n x·ª≠ l√Ω s·ª± c·ªë h·ªá th·ªëng](#xu-ly-su-co)

---

<h2 id="chuan-bi-may-chu">üß∞ Chu·∫©n b·ªã</h2>
<h4 id="cau-hinh-may-chu">‚ú® C·∫•u h√¨nh m√°y ch·ªß</h4>
Tri·ªÉn khai trong m√¥i tr∆∞·ªùng th·ª±c t·∫ø th√¨ ch√∫ng ta c·∫ßn chu·∫©n b·ªã c√°c m√°y ch·ªß v·ªõi th√¥ng s·ªë nh∆∞ sau: |
M√¥i tr∆∞·ªùng | S·ªë l∆∞·ª£ng VM| Ghi ch√∫ m√¥ h√¨nh |
|-------------------------|----------------------|-----------------| | Lab/Test/Dev (demo) | 3-4 VM
| G·ªôp MON, MGR, MDS v√† OSD tr√™n c√πng node | | UAT/Staging | 5-6 VM | T√°ch vai tr√≤, c√≥ standby MDS |
| Production nh·ªè | 6-8 VM | HA ƒë·∫ßy ƒë·ªß, MON quorum, MGR standby, MDS active/standby, OSD t√°ch bi·ªát |
| Production l·ªõn | 9-15+ VM | M·ªói vai tr√≤ ch·∫°y node ri√™ng, OSD nhi·ªÅu disk, scale CephFS |

| M√¥i tr∆∞·ªùng               | Ubuntu LTS phi√™n b·∫£n    | Kernel t·ªëi thi·ªÉu | RAM m·ªói node | CPU m·ªói node |
| ------------------------ | ----------------------- | ---------------- | ------------ | ------------ |
| Lab/Test/Dev (demo)      | 20.04 ho·∫∑c 22.04        | ‚â• 5.4            | 4 GB         | 2 vCPU       |
| Dev / Staging            | ‚úÖ 22.04 LTS            | ‚â• 5.15           | 6‚Äì8 GB       | 2‚Äì4 vCPU     |
| Production nh·ªè g·ªçn       | ‚úÖ 22.04 LTS            | ‚â• 5.15           | 8‚Äì16 GB      | 4 vCPU       |
| üè¢ Production quy m√¥ l·ªõn | ‚úÖ 22.04 ho·∫∑c ‚ö†Ô∏è24.04\* | ‚â• 5.15           | 16‚Äì64 GB     | 8+ vCPU      |

> Ubuntu 24.04 m·ªõi ra, c·∫ßn ki·ªÉm ch·ª©ng th√™m tr∆∞·ªõc khi d√πng cho production.
> T√πy thu·ªôc v√†o s·ªë l∆∞·ª£ng OSD, MDS, MON, MGR m√† ch√∫ng ta c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh th√¥ng s·ªë RAM v√† CPU cho ph√π h·ª£p v·ªõi nhu c·∫ßu s·ª≠ d·ª•ng c·ªßa m√¨nh.

<h4 id="mo-hinh-thiet-ke">‚ú® M√¥ h√¨nh thi·∫øt k·∫ø</h4>
Tri·ªÉn khai CephFS v·ªõi 3 node ``` +-------------+ | Client(s) | +-------------+ | Mount CephFS |
+----------------------------+ | Ceph Cluster Network | +----------------------------+
+------------+------------+-------------+------------+-----------+ | | | +--------+ +--------+
+--------+ | node1 | | node2 | | node3 | |--------| |--------| |--------| | MON | | MON | | MON | |
MGR(A) | | MGR(S) | | | | MDS(A) | | MDS(S) | | | | OSD | | OSD | | OSD | +--------+ +--------+
+--------+

```

<h2 id="tuning-os-he-thong">üß∞ Tuning OS h·ªá th·ªëng</h2>

**Tuning file /etc/security/limits.conf**
```

soft nofile 1048576
hard nofile 1048576
soft nproc 1048576
hard nproc 1048576

```
**Tuning file /etc/systemd/system.conf**
```

DefaultLimitNOFILE=1048576
DefaultLimitNPROC=1048576

```
**T·∫Øt swapoff**
```

swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab

```

```

sudo systemctl daemon-reexec

```

**Tinh file sysctl**
```

# ==========================================

# Ceph Node OS Tuning - sysctl config

# File: /etc/sysctl.d/90-ceph.conf

# ==========================================

# -----------------------------

# 1. CPU Scheduler Optimization

# -----------------------------

kernel.sched_min_granularity_ns = 10000000 # Gi·∫£m ƒë·ªô tr·ªÖ x·ª≠ l√Ω t√°c v·ª• nh·ªè
kernel.sched_wakeup_granularity_ns = 15000000 # Gi·ªõi h·∫°n m·ª©c ƒë·ªô "wakeup" ƒë·ªÉ gi·∫£m context switch
kernel.sched_migration_cost_ns = 500000 # TƒÉng chi ph√≠ migrate gi·ªØa CPU ‚Üí gi·ªØ cache locality
kernel.sched_autogroup_enabled = 0 # T·∫Øt t·ª± nh√≥m ti·∫øn tr√¨nh ng∆∞·ªùi d√πng (kh√¥ng c·∫ßn v·ªõi Ceph)

# -----------------------------

# 2. Memory / RAM Optimization

# -----------------------------

vm.swappiness = 10 # Gi·∫£m t·ªëi ƒëa vi·ªác s·ª≠ d·ª•ng swap
vm.dirty_ratio = 20 # T·ªëi ƒëa 20% RAM ch·ª©a d·ªØ li·ªáu ch∆∞a ghi xu·ªëng disk
vm.dirty_background_ratio = 10 # B·∫Øt ƒë·∫ßu flush khi ƒë·∫°t 10% RAM dirty
vm.vfs_cache_pressure = 50 # Gi·ªØ inode/dentry cache l√¢u h∆°n (t·ªët cho CephFS)
vm.min_free_kbytes = 262144 # D·ª± tr·ªØ RAM cho kernel khi memory th·∫•p
vm.zone_reclaim_mode = 0 # T·∫Øt reclaim NUMA zone kh√¥ng c·∫ßn thi·∫øt

# -----------------------------

# 3. Disk I/O Optimization

# -----------------------------

fs.aio-max-nr = 1048576 # TƒÉng s·ªë l∆∞·ª£ng async I/O t·ªëi ƒëa to√†n h·ªá th·ªëng
fs.file-max = 2097152 # TƒÉng s·ªë file descriptor system-wide (fd limit)

# -----------------------------

# 4. Network Stack Tuning

# -----------------------------

net.core.rmem_max = 268435456 # Max buffer nh·∫≠n (recv) cho socket
net.core.wmem_max = 268435456 # Max buffer g·ª≠i (send) cho socket
net.ipv4.tcp_rmem = 4096 87380 268435456 # Min/default/max TCP recv buffer
net.ipv4.tcp_wmem = 4096 65536 268435456 # Min/default/max TCP send buffer
net.core.netdev_max_backlog = 5000 # S·ªë packet c√≥ th·ªÉ x·∫øp h√†ng ch·ªù x·ª≠ l√Ω t·ª´ NIC
net.ipv4.tcp_congestion_control = bbr # S·ª≠ d·ª•ng thu·∫≠t to√°n TCP BBR (hi·ªáu nƒÉng cao)
net.ipv4.tcp_mtu_probing = 1 # B·∫≠t d√≤ MTU ƒë·ªÉ tr√°nh fragmentation

# -----------------------------

# 5. System stability

# -----------------------------

kernel.panic = 10 # Sau 10s l·ªói kernel ‚Üí h·ªá th·ªëng s·∫Ω reboot
kernel.panic_on_oops = 1 # Panic khi c√≥ l·ªói nghi√™m tr·ªçng (kernel oops)

```

<h2 id="cai-dat-ceph">üß∞ C√†i ƒë·∫∑t h·ªá th·ªëng CephFS</h2>

<h2 id="mo-rong-he-thong">üß∞ K·ªãch b·∫£n m·ªü r·ªông h·ªá th·ªëng</h2>

<h2 id="xu-ly-su-co">üß∞ K·ªãch b·∫£n x·ª≠ l√Ω s·ª± c·ªë h·ªá th·ªëng</h2>
```
