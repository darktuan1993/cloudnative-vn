---
title: 'CÃ i Ä‘áº·t Metrics Server trong Kubernetes (K8s)'
description: 'HÆ°á»›ng dáº«n cÃ i Ä‘áº·t vÃ  kiá»ƒm tra Metrics Server Ä‘á»ƒ theo dÃµi tÃ i nguyÃªn trong cá»¥m Kubernetes'
date: '2022-04-08'
tags: ['Kubernetes', 'Metrics Server', 'Monitor', 'DevOps']
authors: ['bachdangtuan']
---

# CÃ i Ä‘áº·t Metrics Server trong Kubernete

**Kubernetes (K8s) Metrics Server** lÃ  má»™t thÃ nh pháº§n trong cá»¥m Kubernetes cÃ³ nhiá»‡m vá»¥ thu tháº­p vÃ  tá»•ng há»£p dá»¯ liá»‡u vá» tÃ i nguyÃªn (nhÆ° CPU vÃ  RAM) tá»« cÃ¡c **node** vÃ  **pod**. Dá»¯ liá»‡u nÃ y há»— trá»£ viá»‡c:

- GiÃ¡m sÃ¡t vÃ  tá»‘i Æ°u hÃ³a sá»­ dá»¥ng tÃ i nguyÃªn
- PhÃ¡t hiá»‡n sá»± cá»‘ tiá»m áº©n
- NÃ¢ng cao hiá»‡u suáº¥t toÃ n cá»¥m

Metrics Server cung cáº¥p má»™t API endpoint Ä‘á»ƒ cÃ¡c cÃ´ng cá»¥ khÃ¡c truy váº¥n vÃ  hiá»ƒn thá»‹ dá»¯ liá»‡u tÃ i nguyÃªn.

---

## ğŸ“‘ Má»¥c Lá»¥c

1. [YÃªu cáº§u há»‡ thá»‘ng](#yeu-cau-he-thong)
2. [BÆ°á»›c 1: Táº£i xuá»‘ng Metrics Server Manifest](#buoc-1-tai-xuong-metrics-server-manifest)
3. [BÆ°á»›c 2: Chá»‰nh sá»­a file YAML cá»§a Metrics Server](#buoc-2-chinh-sua-file-yaml-cua-metrics-server)
4. [BÆ°á»›c 3: Triá»ƒn khai Metrics Server](#buoc-3-trien-khai-metrics-server)
5. [BÆ°á»›c 4: Kiá»ƒm tra Metrics Server Ä‘Ã£ triá»ƒn khai](#buoc-4-kiem-tra-metrics-server-da-trien-khai)
6. [BÆ°á»›c 5: Kiá»ƒm tra hoáº¡t Ä‘á»™ng Metrics Server](#buoc-5-kiem-tra-hoat-dong-metrics-server)

---

<h2 id="yeu-cau-he-thong">ğŸ§° YÃªu Cáº§u Há»‡ Thá»‘ng</h2>

- Má»™t cá»¥m Kubernetes (phiÃªn báº£n v1.21 trá»Ÿ lÃªn) Ä‘ang hoáº¡t Ä‘á»™ng
- ÄÃ£ cÃ i Ä‘áº·t cÃ´ng cá»¥ dÃ²ng lá»‡nh `kubectl` vÃ  káº¿t ná»‘i vá»›i cá»¥m
- CÃ³ quyá»n táº¡o vÃ  chá»‰nh sá»­a tÃ i nguyÃªn Kubernetes

---

<h2 id="buoc-1-tai-xuong-metrics-server-manifest">â¬‡ï¸ BÆ°á»›c 1: Táº£i Xuá»‘ng Metrics Server Manifest</h2>

Táº£i file `components.yaml` má»›i nháº¥t tá»« GitHub chÃ­nh thá»©c cá»§a Metrics Server:

```bash
curl -LO https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

ğŸ‘‰ Náº¿u báº¡n cáº§n cháº¿ Ä‘á»™ **High Availability (HA)**:

```bash
curl -LO https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml
```

---

<h2 id="buoc-2-chinh-sua-file-yaml-cua-metrics-server">
  âœï¸ BÆ°á»›c 2: Chá»‰nh Sá»­a File YAML Cá»§a Metrics Server
</h2>

Má»Ÿ file YAML Ä‘á»ƒ chá»‰nh sá»­a:

```bash
vi components.yaml
```

### TÃ¬m pháº§n container cÃ³ `args:` vÃ  thÃªm dÃ²ng:

```yaml
- --kubelet-insecure-tls
```

![kube-apiserver](/static/images/metricsserver.png)
{/* ![kube-apiserver.yaml](https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png) */}
DÃ²ng nÃ y cho phÃ©p Metrics Server káº¿t ná»‘i vá»›i kubelet khÃ´ng cáº§n xÃ¡c thá»±c TLS (thÆ°á»ng dÃ¹ng khi kubelet chÆ°a cáº¥u hÃ¬nh CA Ä‘Ãºng cÃ¡ch).

### Sau Ä‘Ã³, thÃªm cáº¥u hÃ¬nh `hostNetwork: true` vÃ o pháº§n `spec` Ä‘á»ƒ container cÃ³ thá»ƒ sá»­ dá»¥ng máº¡ng cá»§a node:

```yaml
spec:
  hostNetwork: true
```

LÆ°u file vÃ  thoÃ¡t.

---

<h2 id="buoc-3-trien-khai-metrics-server">ğŸš€ BÆ°á»›c 3: Triá»ƒn Khai Metrics Server</h2>

DÃ¹ng `kubectl` Ä‘á»ƒ triá»ƒn khai Metrics Server:

```bash
kubectl apply -f components.yaml
```

Lá»‡nh nÃ y sáº½ táº¡o ra cÃ¡c tÃ i nguyÃªn (Deployment, Service, RBACâ€¦) trong cá»¥m.

---

<h2 id="buoc-4-kiem-tra-metrics-server-da-trien-khai">
  ğŸ” BÆ°á»›c 4: Kiá»ƒm Tra Metrics Server ÄÃ£ Triá»ƒn Khai
</h2>

Kiá»ƒm tra tráº¡ng thÃ¡i cá»§a cÃ¡c pod trong namespace `kube-system`:

```bash
kubectl get pods -n kube-system
```

Báº¡n sáº½ tháº¥y má»™t pod cÃ³ tÃªn `metrics-server-xxxxx` Ä‘ang á»Ÿ tráº¡ng thÃ¡i `Running` náº¿u triá»ƒn khai thÃ nh cÃ´ng.

---

<h2 id="buoc-5-kiem-tra-hoat-dong-metrics-server">ğŸ“Š BÆ°á»›c 5: Kiá»ƒm Tra Hoáº¡t Äá»™ng Metrics Server</h2>

### Kiá»ƒm tra tÃ i nguyÃªn sá»­ dá»¥ng cá»§a cÃ¡c node:

```bash
kubectl top nodes
```

Báº¡n sáº½ tháº¥y thÃ´ng tin CPU vÃ  RAM Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng cho tá»«ng node.

### Kiá»ƒm tra tÃ i nguyÃªn cÃ¡c pod:

```bash
kubectl top pod
```

Hoáº·c cá»¥ thá»ƒ namespace (vÃ­ dá»¥ `kube-system`):

```bash
kubectl top pod -n kube-system
```

![kube-apiserver](/static/images/Metrics-Server-Pods-Status-Kube-System.webp)

Náº¿u báº¡n tháº¥y cÃ¡c sá»‘ liá»‡u xuáº¥t hiá»‡n â†’ Metrics Server hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng âœ…

---

## âœ… Tá»•ng Káº¿t

Sau khi hoÃ n táº¥t 5 bÆ°á»›c trÃªn, báº¡n Ä‘Ã£ cÃ i Ä‘áº·t thÃ nh cÃ´ng Metrics Server Ä‘á»ƒ:

- GiÃ¡m sÃ¡t tÃ i nguyÃªn trong cá»¥m
- Káº¿t há»£p vá»›i HPA (Horizontal Pod Autoscaler)
- NÃ¢ng cao nÄƒng lá»±c quáº£n lÃ½ Kubernetes

Náº¿u báº¡n gáº·p khÃ³ khÄƒn trong quÃ¡ trÃ¬nh triá»ƒn khai, hÃ£y Ä‘á»ƒ láº¡i cÃ¢u há»i Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ thÃªm!
